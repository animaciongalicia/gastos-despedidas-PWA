<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <meta name="theme-color" content="#E91E63">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <title>Gestor de Despedidas | despedidasgalicia.es</title>
    <link rel="manifest" href="manifest.json">
    <link rel="apple-touch-icon" href="icon-192.png">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Bebas+Neue&family=DM+Sans:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        :root {
            --primary: #E91E63;
            --primary-dark: #C2185B;
            --primary-light: #F8BBD9;
            --secondary: #1A1A2E;
            --accent: #FFD700;
            --success: #4CAF50;
            --warning: #FF9800;
            --danger: #FF5722;
            --bg: #FAFAFA;
            --bg-card: #FFFFFF;
            --text: #1A1A2E;
            --text-muted: #6B7280;
            --border: #E5E7EB;
            --shadow: 0 4px 20px rgba(26, 26, 46, 0.08);
            --radius: 16px;
            --radius-sm: 10px;
        }
        * { margin: 0; padding: 0; box-sizing: border-box; -webkit-tap-highlight-color: transparent; }
        body { font-family: 'DM Sans', -apple-system, sans-serif; background: var(--bg); color: var(--text); min-height: 100vh; }
        .app { max-width: 480px; margin: 0 auto; min-height: 100vh; background: var(--bg); }
        .screen { display: none; min-height: 100vh; padding: 20px; padding-bottom: 100px; }
        .screen.active { display: block; }
        .header { text-align: center; padding: 20px 0 30px; }
        .header-logo { font-family: 'Bebas Neue', sans-serif; font-size: 28px; color: var(--primary); letter-spacing: 2px; }
        .header-subtitle { font-size: 12px; color: var(--text-muted); }
        .hero { background: linear-gradient(135deg, var(--primary), var(--primary-dark)); border-radius: var(--radius); padding: 40px 24px; text-align: center; color: white; margin-bottom: 30px; }
        .hero h1 { font-family: 'Bebas Neue', sans-serif; font-size: 32px; margin-bottom: 10px; }
        .hero p { font-size: 15px; opacity: 0.9; }
        .btn { display: flex; align-items: center; justify-content: center; gap: 10px; width: 100%; padding: 18px 24px; border: none; border-radius: var(--radius-sm); font-family: inherit; font-size: 16px; font-weight: 600; cursor: pointer; transition: all 0.2s; }
        .btn-primary { background: var(--primary); color: white; }
        .btn-primary:active { background: var(--primary-dark); transform: scale(0.98); }
        .btn-secondary { background: var(--bg-card); color: var(--text); border: 2px solid var(--border); }
        .btn-accent { background: var(--accent); color: var(--secondary); }
        .btn-danger { background: var(--danger); color: white; }
        .btn-small { padding: 12px 20px; font-size: 14px; }
        .btn-group { display: flex; gap: 10px; }
        .btn-group .btn { flex: 1; }
        .form-group { margin-bottom: 20px; }
        .form-label { display: block; font-size: 14px; font-weight: 600; margin-bottom: 8px; }
        .form-input { width: 100%; padding: 16px; border: 2px solid var(--border); border-radius: var(--radius-sm); font-family: inherit; font-size: 16px; background: var(--bg-card); }
        .form-input:focus { outline: none; border-color: var(--primary); }
        .card { background: var(--bg-card); border-radius: var(--radius); padding: 20px; box-shadow: var(--shadow); margin-bottom: 16px; }
        .card-title { font-size: 18px; font-weight: 700; margin-bottom: 16px; }
        .stats-grid { display: grid; grid-template-columns: repeat(2, 1fr); gap: 12px; margin-bottom: 20px; }
        .stat-card { background: var(--bg-card); border-radius: var(--radius-sm); padding: 16px; text-align: center; box-shadow: var(--shadow); }
        .stat-value { font-family: 'Bebas Neue', sans-serif; font-size: 32px; color: var(--primary); }
        .stat-value.success { color: var(--success); }
        .stat-value.danger { color: var(--danger); }
        .stat-label { font-size: 12px; color: var(--text-muted); margin-top: 4px; }
        .event-banner { background: linear-gradient(135deg, var(--secondary), #2D2D44); border-radius: var(--radius); padding: 20px; color: white; margin-bottom: 20px; }
        .event-city { font-family: 'Bebas Neue', sans-serif; font-size: 24px; }
        .event-code { background: rgba(255,255,255,0.15); padding: 6px 12px; border-radius: 20px; font-size: 12px; display: inline-block; margin-top: 8px; cursor: pointer; }
        .event-date { font-size: 14px; opacity: 0.8; margin-top: 4px; }
        .attendee-item { display: flex; align-items: center; gap: 14px; padding: 14px 0; border-bottom: 1px solid var(--border); cursor: pointer; }
        .attendee-item:last-child { border-bottom: none; }
        .attendee-item:active { background: var(--bg); }
        .attendee-avatar { width: 48px; height: 48px; border-radius: 50%; background: var(--primary-light); display: flex; align-items: center; justify-content: center; font-weight: 700; font-size: 18px; color: var(--primary); flex-shrink: 0; }
        .attendee-avatar.vip { background: var(--accent); color: var(--secondary); }
        .attendee-info { flex: 1; min-width: 0; }
        .attendee-name { font-weight: 600; font-size: 15px; display: flex; align-items: center; gap: 8px; flex-wrap: wrap; }
        .badge { font-size: 10px; padding: 3px 8px; border-radius: 20px; font-weight: 600; }
        .badge-vip { background: var(--accent); color: var(--secondary); }
        .badge-paid { background: var(--success); color: white; }
        .badge-pending { background: var(--danger); color: white; }
        .badge-partial { background: var(--warning); color: white; }
        .attendee-amount { font-size: 13px; color: var(--text-muted); }
        .attendee-amount strong { color: var(--text); }
        .category-item { display: flex; align-items: center; justify-content: space-between; padding: 16px; background: var(--bg-card); border-radius: var(--radius-sm); margin-bottom: 10px; box-shadow: var(--shadow); cursor: pointer; }
        .category-item:active { transform: scale(0.98); }
        .category-left { display: flex; align-items: center; gap: 14px; }
        .category-icon { width: 44px; height: 44px; border-radius: 12px; display: flex; align-items: center; justify-content: center; font-size: 22px; }
        .category-name { font-weight: 600; }
        .category-count { font-size: 12px; color: var(--text-muted); }
        .category-amount { font-weight: 700; }
        .bottom-nav { position: fixed; bottom: 0; left: 50%; transform: translateX(-50%); width: 100%; max-width: 480px; background: var(--bg-card); border-top: 1px solid var(--border); display: none; justify-content: space-around; padding: 10px 0 20px; z-index: 100; }
        .bottom-nav.visible { display: flex; }
        .nav-item { display: flex; flex-direction: column; align-items: center; gap: 4px; padding: 8px 16px; border: none; background: none; cursor: pointer; color: var(--text-muted); }
        .nav-item.active { color: var(--primary); }
        .nav-item span:first-child { font-size: 24px; }
        .nav-item span:last-child { font-size: 11px; font-weight: 600; }
        .modal-overlay { display: none; position: fixed; inset: 0; background: rgba(0,0,0,0.5); z-index: 200; align-items: flex-end; justify-content: center; }
        .modal-overlay.active { display: flex; }
        .modal { background: var(--bg-card); width: 100%; max-width: 480px; border-radius: var(--radius) var(--radius) 0 0; padding: 24px; padding-bottom: 40px; max-height: 90vh; overflow-y: auto; }
        .modal-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 24px; }
        .modal-title { font-size: 20px; font-weight: 700; }
        .modal-close { width: 36px; height: 36px; border-radius: 50%; border: none; background: var(--bg); cursor: pointer; font-size: 18px; }
        .toggle-group { display: flex; align-items: center; justify-content: space-between; padding: 12px 0; }
        .toggle { width: 52px; height: 28px; background: var(--border); border-radius: 20px; position: relative; cursor: pointer; }
        .toggle.active { background: var(--primary); }
        .toggle::after { content: ''; position: absolute; width: 22px; height: 22px; background: white; border-radius: 50%; top: 3px; left: 3px; transition: transform 0.2s; }
        .toggle.active::after { transform: translateX(24px); }
        .chips { display: flex; flex-wrap: wrap; gap: 8px; margin-top: 10px; }
        .chip { padding: 8px 14px; background: var(--bg); border: 2px solid var(--border); border-radius: 20px; font-size: 13px; cursor: pointer; }
        .chip.selected { background: var(--primary-light); border-color: var(--primary); color: var(--primary); }
        .expense-item { display: flex; justify-content: space-between; padding: 14px; background: var(--bg); border-radius: var(--radius-sm); margin-bottom: 8px; cursor: pointer; }
        .expense-item:active { opacity: 0.7; }
        .expense-name { font-weight: 600; font-size: 14px; }
        .expense-payer { font-size: 12px; color: var(--text-muted); }
        .expense-amount { font-weight: 700; }
        .empty-state { text-align: center; padding: 40px 20px; color: var(--text-muted); }
        .empty-state-icon { font-size: 48px; margin-bottom: 16px; }
        .back-btn { display: flex; align-items: center; gap: 8px; background: none; border: none; color: var(--text-muted); font-size: 14px; cursor: pointer; padding: 8px 0; margin-bottom: 16px; }
        .divider { display: flex; align-items: center; gap: 16px; margin: 24px 0; color: var(--text-muted); font-size: 13px; }
        .divider::before, .divider::after { content: ''; flex: 1; height: 1px; background: var(--border); }
        .toast { position: fixed; bottom: 100px; left: 50%; transform: translateX(-50%) translateY(100px); background: var(--secondary); color: white; padding: 14px 24px; border-radius: var(--radius-sm); font-size: 14px; z-index: 300; opacity: 0; transition: all 0.3s; }
        .toast.show { opacity: 1; transform: translateX(-50%) translateY(0); }
        .whatsapp-preview { background: #DCF8C6; border-radius: var(--radius-sm); padding: 16px; font-size: 14px; line-height: 1.6; white-space: pre-wrap; max-height: 300px; overflow-y: auto; }
        .share-code { font-family: 'Bebas Neue', monospace; font-size: 28px; letter-spacing: 3px; text-align: center; color: var(--primary); padding: 16px; background: var(--bg); border-radius: var(--radius-sm); margin-bottom: 12px; }
        .info-text { font-size: 12px; color: var(--text-muted); margin-top: 8px; }
        .danger-zone { margin-top: 30px; padding-top: 20px; border-top: 1px solid var(--border); }
        .mb-10 { margin-bottom: 10px; }
        .mb-20 { margin-bottom: 20px; }
        .mt-20 { margin-top: 20px; }
        .text-center { text-align: center; }
        .text-muted { color: var(--text-muted); }
    </style>
</head>
<body>
    <div class="app" id="app">
        <!-- HOME -->
        <div class="screen active" id="screen-home">
            <div class="header">
                <div class="header-logo">DESPEDIDAS GALICIA</div>
                <div class="header-subtitle">Gestor de Gastos</div>
            </div>
            <div class="hero">
                <h1>üéâ ORGANIZA TU DESPEDIDA</h1>
                <p>Controla gastos, pagos y divide cuentas sin dramas. El novio/a nunca paga.</p>
            </div>
            
            <div class="card mb-20">
                <div class="card-title">üí° ¬øPara qu√© sirve esto?</div>
                <div style="font-size:14px;line-height:1.6;color:var(--text-muted)">
                    <p style="margin-bottom:10px">‚úÖ <strong>Conserva amistades</strong> ‚Äî Que el dinero no rompa la fiesta</p>
                    <p style="margin-bottom:10px">‚úÖ <strong>Adi√≥s al caos</strong> ‚Äî Ni excels, ni gaitas "¬øqui√©n pag√≥ qu√©?"</p>
                    <p style="margin-bottom:10px">‚úÖ <strong>El prota no paga</strong> ‚Äî Se divide autom√°ticamente entre los dem√°s</p>
                    <p style="margin-bottom:10px">‚úÖ <strong>Cada uno lo suyo</strong> ‚Äî Si no se va a una actividad, no se paga</p>
                    <p>‚úÖ <strong>Comparte f√°cil</strong> ‚Äî PDF y WhatsApp con un click</p>
                </div>
            </div>
            
            <button class="btn btn-primary mb-20" id="btn-create">üéâ Crear nueva despedida</button>
            <div class="divider">o</div>
            <button class="btn btn-secondary" id="btn-recover">üîë Tengo un c√≥digo</button>
            <p class="text-center text-muted mt-20" style="font-size:12px">üìû 678 288 284 ¬∑ www.despedidasgalicia.es</p>
            <p class="text-center mt-20" style="font-size:11px;color:var(--text-muted);font-style:italic">"Boas festas e mellores resacas" üçª</p>
        </div>

        <!-- CREATE -->
        <div class="screen" id="screen-create">
            <button class="back-btn" id="btn-back-home">‚Üê Volver</button>
            <h2 style="font-size:24px;margin-bottom:8px">Nueva Despedida</h2>
            <p class="text-muted mb-20">Rellena los datos para empezar</p>
            <div class="form-group">
                <label class="form-label">Tu nombre *</label>
                <input type="text" class="form-input" id="inp-name" placeholder="¬øC√≥mo te llamas?">
            </div>
            <div class="form-group">
                <label class="form-label">Tu WhatsApp *</label>
                <input type="tel" class="form-input" id="inp-phone" placeholder="678 123 456">
            </div>
            <div class="form-group">
                <label class="form-label">Ciudad del evento *</label>
                <input type="text" class="form-input" id="inp-city" placeholder="A Coru√±a, Vigo, Sanxenxo...">
            </div>
            <div class="form-group">
                <label class="form-label">Fecha del evento *</label>
                <input type="date" class="form-input" id="inp-date">
            </div>
            <div class="form-group">
                <label class="form-label">¬øDespedida de...?</label>
                <div class="chips" id="type-chips">
                    <span class="chip selected" data-type="soltera">üë∞ Soltera</span>
                    <span class="chip" data-type="soltero">ü§µ Soltero</span>
                </div>
            </div>
            <button class="btn btn-primary mt-20" id="btn-submit-create">Crear despedida üöÄ</button>
        </div>

        <!-- DASHBOARD -->
        <div class="screen" id="screen-dashboard">
            <div class="event-banner">
                <div class="event-city" id="dash-city">-</div>
                <div class="event-date" id="dash-date">-</div>
                <div class="event-code" id="dash-code">-</div>
            </div>
            <div class="stats-grid">
                <div class="stat-card"><div class="stat-value" id="stat-total">0‚Ç¨</div><div class="stat-label">Total</div></div>
                <div class="stat-card"><div class="stat-value" id="stat-perperson">0‚Ç¨</div><div class="stat-label">Por persona</div></div>
                <div class="stat-card"><div class="stat-value success" id="stat-paid">0‚Ç¨</div><div class="stat-label">Pagado</div></div>
                <div class="stat-card"><div class="stat-value danger" id="stat-pending">0‚Ç¨</div><div class="stat-label">Pendiente</div></div>
            </div>
            <div class="card">
                <div style="display:flex;gap:10px">
                    <button class="btn btn-secondary btn-small" style="flex:1" id="btn-share">üì§ Compartir</button>
                    <button class="btn btn-accent btn-small" style="flex:1" id="btn-whatsapp">üí¨ WhatsApp</button>
                </div>
            </div>
        </div>

        <!-- ATTENDEES -->
        <div class="screen" id="screen-attendees">
            <h2 style="font-size:24px;margin-bottom:20px">Asistentes</h2>
            <div id="attendees-list"></div>
            <div class="btn-group mt-20">
                <button class="btn btn-primary" id="btn-add-attendee">‚ûï A√±adir</button>
                <button class="btn btn-secondary" id="btn-add-contact">üì± Contactos</button>
            </div>
            <p class="info-text text-center">Toca un asistente para editarlo</p>
        </div>

        <!-- EXPENSES -->
        <div class="screen" id="screen-expenses">
            <h2 style="font-size:24px;margin-bottom:20px">Gastos</h2>
            <div id="categories-list"></div>
            <button class="btn btn-secondary mt-20" id="btn-add-category">‚ûï Nueva categor√≠a</button>
        </div>

        <!-- SUMMARY -->
        <div class="screen" id="screen-summary">
            <h2 style="font-size:24px;margin-bottom:20px">Resumen Final</h2>
            <div class="card mb-20">
                <div class="card-title">Por persona</div>
                <div id="summary-persons"></div>
            </div>
            <div class="card mb-20">
                <div class="card-title">Por categor√≠a</div>
                <div id="summary-categories"></div>
            </div>
            <div style="display:flex;gap:10px">
                <button class="btn btn-secondary" style="flex:1" id="btn-pdf">üìÑ PDF</button>
                <button class="btn btn-primary" style="flex:1" id="btn-whatsapp2">üí¨ WhatsApp</button>
            </div>
        </div>

        <!-- CATEGORY DETAIL -->
        <div class="screen" id="screen-category">
            <button class="back-btn" id="btn-back-expenses">‚Üê Volver</button>
            <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:20px">
                <h2 id="cat-title">-</h2>
                <span id="cat-total" style="font-weight:700">0‚Ç¨</span>
            </div>
            <div id="expenses-list"></div>
            <button class="btn btn-primary mt-20" id="btn-add-expense">‚ûï A√±adir gasto</button>
            <p class="info-text text-center">Toca un gasto para editarlo</p>
        </div>

        <!-- NAV -->
        <nav class="bottom-nav" id="bottom-nav">
            <button class="nav-item active" data-screen="screen-dashboard"><span>üè†</span><span>Inicio</span></button>
            <button class="nav-item" data-screen="screen-attendees"><span>üë•</span><span>Asistentes</span></button>
            <button class="nav-item" data-screen="screen-expenses"><span>üí∞</span><span>Gastos</span></button>
            <button class="nav-item" data-screen="screen-summary"><span>üìä</span><span>Resumen</span></button>
        </nav>

        <!-- MODALS -->
        <div class="modal-overlay" id="modal-recover">
            <div class="modal">
                <div class="modal-header"><span class="modal-title">Recuperar despedida</span><button class="modal-close" data-close="modal-recover">‚úï</button></div>
                <div class="form-group"><label class="form-label">C√≥digo</label><input type="text" class="form-input" id="inp-recover" placeholder="DESP-XXXXX" style="text-transform:uppercase"></div>
                <button class="btn btn-primary" id="btn-submit-recover">Acceder</button>
            </div>
        </div>

        <!-- ADD/EDIT ATTENDEE -->
        <div class="modal-overlay" id="modal-attendee">
            <div class="modal">
                <div class="modal-header"><span class="modal-title" id="modal-att-title">A√±adir asistente</span><button class="modal-close" data-close="modal-attendee">‚úï</button></div>
                <input type="hidden" id="edit-att-id">
                <div class="form-group"><label class="form-label">Nombre / Apodo *</label><input type="text" class="form-input" id="inp-att-name" placeholder="Pepe, Mar√≠a, El

 





"></div>
                <div class="form-group"><label class="form-label">Tel√©fono</label><input type="tel" class="form-input" id="inp-att-phone" placeholder="678 123 456"></div>
                <div class="form-group">
                    <label class="form-label">Rol</label>
                    <div class="chips" id="role-chips">
                        <span class="chip selected" data-role="invitado">üéâ Invitado/a</span>
                        <span class="chip" data-role="organizador">üìã Organizador/a</span>
                        <span class="chip" data-role="protagonista">üëë Novio/Novia</span>
                    </div>
                    <p class="info-text">El novio/novia nunca paga</p>
                </div>
                <div class="form-group" id="paid-group" style="display:none">
                    <label class="form-label">Ya ha pagado (‚Ç¨)</label>
                    <input type="number" class="form-input" id="inp-att-paid" placeholder="0" step="0.01">
                    <p class="info-text">Adelantos, se√±ales... se descontar√° de lo que debe</p>
                </div>
                <button class="btn btn-primary mt-20" id="btn-submit-attendee">Guardar</button>
                <div class="danger-zone" id="att-danger" style="display:none">
                    <button class="btn btn-danger" id="btn-delete-attendee">üóëÔ∏è Eliminar asistente</button>
                </div>
            </div>
        </div>

        <!-- ADD CATEGORY -->
        <div class="modal-overlay" id="modal-category">
            <div class="modal">
                <div class="modal-header"><span class="modal-title">Nueva categor√≠a</span><button class="modal-close" data-close="modal-category">‚úï</button></div>
                <div class="form-group"><label class="form-label">Nombre *</label><input type="text" class="form-input" id="inp-cat-name" placeholder="Stripper, Barco..."></div>
                <div class="form-group"><label class="form-label">Icono</label>
                    <div class="chips" id="icon-chips">
                        <span class="chip selected" data-icon="üéØ">üéØ</span><span class="chip" data-icon="üö§">üö§</span><span class="chip" data-icon="üíÉ">üíÉ</span><span class="chip" data-icon="üéÆ">üéÆ</span><span class="chip" data-icon="üçª">üçª</span><span class="chip" data-icon="üéÅ">üéÅ</span><span class="chip" data-icon="üöå">üöå</span><span class="chip" data-icon="üíÖ">üíÖ</span><span class="chip" data-icon="üé§">üé§</span><span class="chip" data-icon="üèñÔ∏è">üèñÔ∏è</span>
                    </div>
                </div>
                <button class="btn btn-primary mt-20" id="btn-submit-category">Crear</button>
            </div>
        </div>

        <!-- ADD/EDIT EXPENSE -->
        <div class="modal-overlay" id="modal-expense">
            <div class="modal">
                <div class="modal-header"><span class="modal-title" id="modal-exp-title">A√±adir gasto</span><button class="modal-close" data-close="modal-expense">‚úï</button></div>
                <input type="hidden" id="edit-exp-id">
                <div class="form-group"><label class="form-label">Concepto *</label><input type="text" class="form-input" id="inp-exp-name" placeholder="Reserva, Entrada..."></div>
                <div class="form-group"><label class="form-label">Importe ‚Ç¨ *</label><input type="number" class="form-input" id="inp-exp-amount" placeholder="0" step="0.01"></div>
                <div class="form-group"><label class="form-label">¬øQui√©n lo pag√≥?</label><select class="form-input" id="inp-exp-payer"><option value="">Nadie a√∫n / Bote com√∫n</option></select></div>
                <div class="form-group">
                    <label class="form-label">¬øQui√©nes participan?</label>
                    <p class="info-text mb-10">Desmarca a quien no vaya a esta actividad</p>
                    <div class="chips" id="exp-participants"></div>
                </div>
                <button class="btn btn-primary mt-20" id="btn-submit-expense">Guardar</button>
                <div class="danger-zone" id="exp-danger" style="display:none">
                    <button class="btn btn-danger" id="btn-delete-expense">üóëÔ∏è Eliminar gasto</button>
                </div>
            </div>
        </div>

        <!-- SHARE -->
        <div class="modal-overlay" id="modal-share">
            <div class="modal">
                <div class="modal-header"><span class="modal-title">Compartir</span><button class="modal-close" data-close="modal-share">‚úï</button></div>
                <div class="share-code" id="share-code">-</div>
                <div style="display:flex;gap:10px"><button class="btn btn-secondary btn-small" style="flex:1" id="btn-copy-code">üìã Copiar</button><button class="btn btn-primary btn-small" style="flex:1" id="btn-share-wa">üí¨ WhatsApp</button></div>
                <p class="info-text text-center mt-20">Los asistentes pueden ver el resumen con este c√≥digo (solo lectura)</p>
            </div>
        </div>

        <!-- WHATSAPP MESSAGE -->
        <div class="modal-overlay" id="modal-whatsapp">
            <div class="modal">
                <div class="modal-header"><span class="modal-title">Mensaje</span><button class="modal-close" data-close="modal-whatsapp">‚úï</button></div>
                <div class="whatsapp-preview" id="wa-preview"></div>
                <div style="display:flex;gap:10px;margin-top:20px"><button class="btn btn-secondary" style="flex:1" id="btn-copy-wa">üìã Copiar</button><button class="btn btn-primary" style="flex:1" id="btn-send-wa">üí¨ Enviar</button></div>
            </div>
        </div>

        <div class="toast" id="toast"></div>
    </div>

<script>
// ==================== APP STATE ====================
const DEFAULT_CATS = [
    {id:'alojamiento',name:'Alojamiento',icon:'üè®',color:'#4CAF50'},
    {id:'actividades',name:'Actividades',icon:'üéØ',color:'#2196F3'},
    {id:'comida',name:'Comida',icon:'üçΩÔ∏è',color:'#FF9800'},
    {id:'cena',name:'Cena',icon:'ü•Ç',color:'#9C27B0'},
    {id:'copas',name:'Copas',icon:'üçª',color:'#E91E63'},
    {id:'imprevistos',name:'Imprevistos',icon:'üí∏',color:'#607D8B'}
];

let E = null; // Current Event
let catId = null; // Current Category ID

// ==================== HELPERS ====================
const $ = id => document.getElementById(id);
const $$ = sel => document.querySelectorAll(sel);

function toast(msg) {
    const t = $('toast');
    t.textContent = msg;
    t.classList.add('show');
    setTimeout(() => t.classList.remove('show'), 2500);
}

function genCode() {
    const c = 'ABCDEFGHJKLMNPQRSTUVWXYZ23456789';
    let r = 'DESP-';
    for(let i=0;i<5;i++) r += c[Math.floor(Math.random()*c.length)];
    return r;
}

// ==================== STORAGE ====================
function save() {
    if(E) {
        localStorage.setItem('ev_'+E.code, JSON.stringify(E));
        localStorage.setItem('lastCode', E.code);
    }
}

function load(code) {
    const d = localStorage.getItem('ev_'+code);
    if(d) { E = JSON.parse(d); return true; }
    return false;
}

// ==================== NAVIGATION ====================
function nav(screenId) {
    const needsEvent = ['screen-dashboard','screen-attendees','screen-expenses','screen-summary','screen-category'];
    if(needsEvent.includes(screenId) && !E) {
        nav('screen-home');
        return;
    }
    $$('.screen').forEach(s => s.classList.remove('active'));
    $(screenId).classList.add('active');
    
    const showNav = needsEvent.includes(screenId) && screenId !== 'screen-category';
    $('bottom-nav').classList.toggle('visible', showNav);
    
    $$('.nav-item').forEach(n => n.classList.toggle('active', n.dataset.screen === screenId));
    
    if(screenId === 'screen-dashboard') renderDash();
    if(screenId === 'screen-attendees') renderAtt();
    if(screenId === 'screen-expenses') renderCats();
    if(screenId === 'screen-summary') renderSummary();
    if(screenId === 'screen-category') renderExpenses();
}

function openModal(id) { $(id).classList.add('active'); }
function closeModal(id) { $(id).classList.remove('active'); }

// ==================== CALCULATIONS ====================
function calcStats() {
    const total = E.expenses.reduce((s,x) => s + x.amount, 0);
    const paying = E.attendees.filter(a => !a.vip);
    const pp = paying.length ? total / paying.length : 0;
    
    // Paid = direct payments from attendees + expenses paid by someone
    let paid = E.attendees.reduce((s,a) => s + (a.paid||0), 0);
    paid += E.expenses.filter(x=>x.paidBy).reduce((s,x)=>s+x.amount,0);
    
    return {total, pp, paid, pending: Math.max(0, total-paid)};
}

function calcPersonStats() {
    const stats = {};
    E.attendees.forEach(a => stats[a.id] = {owes:0, paid: a.paid||0});
    
    E.expenses.forEach(exp => {
        // Get participants - default to all non-VIP if not specified
        let parts = exp.participants;
        if(!parts || !parts.length) {
            parts = E.attendees.filter(a=>!a.vip).map(a=>a.id);
        }
        
        // Filter to only paying participants (non-VIP)
        const payingParts = parts.filter(id => {
            const att = E.attendees.find(a=>a.id===id);
            return att && !att.vip;
        });
        
        if(payingParts.length) {
            const share = exp.amount / payingParts.length;
            payingParts.forEach(id => {
                if(stats[id]) stats[id].owes += share;
            });
        }
        
        // If someone paid this expense, add to their paid amount
        if(exp.paidBy && stats[exp.paidBy]) {
            stats[exp.paidBy].paid += exp.amount;
        }
    });
    
    return stats;
}

// ==================== RENDER FUNCTIONS ====================
function renderDash() {
    if(!E) return;
    $('dash-city').textContent = E.city;
    $('dash-code').textContent = E.code;
    const d = new Date(E.date);
    $('dash-date').textContent = d.toLocaleDateString('es-ES',{day:'numeric',month:'long',year:'numeric'});
    
    const stats = calcStats();
    $('stat-total').textContent = stats.total.toFixed(0)+'‚Ç¨';
    $('stat-perperson').textContent = stats.pp.toFixed(0)+'‚Ç¨';
    $('stat-paid').textContent = stats.paid.toFixed(0)+'‚Ç¨';
    $('stat-pending').textContent = stats.pending.toFixed(0)+'‚Ç¨';
}

function renderAtt() {
    const list = $('attendees-list');
    if(!E.attendees.length) {
        list.innerHTML = '<div class="empty-state"><div class="empty-state-icon">üë•</div><p>Sin asistentes</p></div>';
        return;
    }
    const stats = calcPersonStats();
    list.innerHTML = E.attendees.map(a => {
        const s = stats[a.id] || {owes:0,paid:0};
        const bal = s.paid - s.owes;
        const role = a.role || (a.vip ? 'protagonista' : 'invitado');
        
        let roleBadge = '';
        if(role === 'protagonista' || a.vip) {
            roleBadge = '<span class="badge badge-vip">üëë NOVIO/A</span>';
        } else if(role === 'organizador') {
            roleBadge = '<span class="badge" style="background:#2196F3;color:white">üìã Organizador</span>';
        }
        
        let statusBadge = '';
        if(role !== 'protagonista' && !a.vip) {
            if(bal >= 0) {
                statusBadge = '<span class="badge badge-paid">‚úì Pagado</span>';
            } else if(s.paid > 0) {
                statusBadge = '<span class="badge badge-partial">Parcial</span>';
            } else {
                statusBadge = '<span class="badge badge-pending">Pendiente</span>';
            }
        }
        
        const isVip = role === 'protagonista' || a.vip;
        
        return `<div class="attendee-item" data-id="${a.id}">
            <div class="attendee-avatar ${isVip?'vip':''}">${a.name.substring(0,2).toUpperCase()}</div>
            <div class="attendee-info">
                <div class="attendee-name">${a.name} ${roleBadge} ${statusBadge}</div>
                <div class="attendee-amount">${isVip ? 'üëë ¬°No paga - es el/la protagonista!' : `Debe: <strong>${Math.max(0,-bal).toFixed(0)}‚Ç¨</strong> ¬∑ Pagado: ${s.paid.toFixed(0)}‚Ç¨`}</div>
            </div>
        </div>`;
    }).join('');
}

function renderCats() {
    $('categories-list').innerHTML = E.categories.map(c => {
        const exps = E.expenses.filter(x => x.catId === c.id);
        const total = exps.reduce((s,x) => s + x.amount, 0);
        return `<div class="category-item" data-id="${c.id}">
            <div class="category-left">
                <div class="category-icon" style="background:${c.color}20;color:${c.color}">${c.icon}</div>
                <div><div class="category-name">${c.name}</div><div class="category-count">${exps.length} gastos</div></div>
            </div>
            <div class="category-amount">${total.toFixed(0)}‚Ç¨</div>
        </div>`;
    }).join('');
}

function renderExpenses() {
    const cat = E.categories.find(c => c.id === catId);
    if(!cat) return;
    $('cat-title').textContent = cat.icon + ' ' + cat.name;
    const exps = E.expenses.filter(x => x.catId === catId);
    $('cat-total').textContent = exps.reduce((s,x)=>s+x.amount,0).toFixed(0)+'‚Ç¨';
    
    if(!exps.length) {
        $('expenses-list').innerHTML = '<div class="empty-state"><div class="empty-state-icon">üí∞</div><p>Sin gastos en esta categor√≠a</p></div>';
        return;
    }
    $('expenses-list').innerHTML = exps.map(x => {
        const payer = x.paidBy ? E.attendees.find(a=>a.id===x.paidBy) : null;
        const numParts = x.participants ? x.participants.length : E.attendees.filter(a=>!a.vip).length;
        return `<div class="expense-item" data-id="${x.id}">
            <div><div class="expense-name">${x.name}</div><div class="expense-payer">${payer?'Pag√≥ '+payer.name:'Pendiente de pago'} ¬∑ ${numParts} personas</div></div>
            <div class="expense-amount">${x.amount.toFixed(0)}‚Ç¨</div>
        </div>`;
    }).join('');
}

function renderSummary() {
    const stats = calcPersonStats();
    $('summary-persons').innerHTML = E.attendees.map(a => {
        const s = stats[a.id] || {owes:0,paid:0};
        const bal = s.paid - s.owes;
        const role = a.role || (a.vip ? 'protagonista' : 'invitado');
        const isVip = role === 'protagonista' || a.vip;
        
        let roleIcon = '';
        if(isVip) roleIcon = 'üëë';
        else if(role === 'organizador') roleIcon = 'üìã';
        
        return `<div class="attendee-item" style="cursor:default">
            <div class="attendee-avatar ${isVip?'vip':''}">${a.name.substring(0,2).toUpperCase()}</div>
            <div class="attendee-info">
                <div class="attendee-name">${a.name} ${roleIcon}</div>
                <div class="attendee-amount">${isVip?'No paga - Protagonista':`Debe: ${s.owes.toFixed(0)}‚Ç¨ ¬∑ Pag√≥: ${s.paid.toFixed(0)}‚Ç¨`}</div>
            </div>
            ${!isVip ? `<div style="font-weight:700;color:${bal>=0?'var(--success)':'var(--danger)'}">${bal>=0?'+':''}${bal.toFixed(0)}‚Ç¨</div>` : ''}
        </div>`;
    }).join('');
    
    // Desglose detallado por categor√≠a con gastos individuales
    let catHtml = '';
    E.categories.forEach(c => {
        const exps = E.expenses.filter(x => x.catId === c.id);
        const total = exps.reduce((s,x) => s + x.amount, 0);
        if(total > 0) {
            catHtml += `<div style="margin-bottom:16px">
                <div style="display:flex;justify-content:space-between;padding:10px 0;border-bottom:2px solid var(--primary-light)">
                    <span style="font-weight:700">${c.icon} ${c.name}</span>
                    <strong style="color:var(--primary)">${total.toFixed(0)}‚Ç¨</strong>
                </div>`;
            exps.forEach(exp => {
                const payer = exp.paidBy ? E.attendees.find(a=>a.id===exp.paidBy) : null;
                catHtml += `<div style="display:flex;justify-content:space-between;padding:6px 0 6px 12px;font-size:13px;color:var(--text-muted)">
                    <span>‚Ä¢ ${exp.name}${payer ? ' <span style="color:var(--success)">('+payer.name+')</span>' : ''}</span>
                    <span>${exp.amount.toFixed(0)}‚Ç¨</span>
                </div>`;
            });
            catHtml += `</div>`;
        }
    });
    const totalGeneral = E.expenses.reduce((s,x) => s + x.amount, 0);
    catHtml += `<div style="display:flex;justify-content:space-between;padding:12px 0;border-top:2px solid var(--secondary);margin-top:8px;font-size:18px">
        <strong>TOTAL</strong><strong style="color:var(--primary)">${totalGeneral.toFixed(0)}‚Ç¨</strong>
    </div>`;
    $('summary-categories').innerHTML = catHtml;
}

// ==================== ATTENDEE ACTIONS ====================
function openAttendeeModal(id = null) {
    const isEdit = !!id;
    $('modal-att-title').textContent = isEdit ? 'Editar asistente' : 'A√±adir asistente';
    $('edit-att-id').value = id || '';
    $('att-danger').style.display = isEdit ? 'block' : 'none';
    $('paid-group').style.display = isEdit ? 'block' : 'none';
    
    // Reset role chips
    $$('#role-chips .chip').forEach(c => c.classList.remove('selected'));
    
    if(isEdit) {
        const a = E.attendees.find(x => x.id === id);
        if(!a) return;
        $('inp-att-name').value = a.name;
        $('inp-att-phone').value = a.phone || '';
        $('inp-att-paid').value = a.paid || 0;
        // Select the right role chip
        const role = a.role || (a.vip ? 'protagonista' : 'invitado');
        const roleChip = document.querySelector(`#role-chips .chip[data-role="${role}"]`);
        if(roleChip) roleChip.classList.add('selected');
        else $$('#role-chips .chip')[0].classList.add('selected');
    } else {
        $('inp-att-name').value = '';
        $('inp-att-phone').value = '';
        $('inp-att-paid').value = 0;
        $$('#role-chips .chip')[0].classList.add('selected'); // Default: invitado
    }
    openModal('modal-attendee');
}

function saveAttendee() {
    const id = $('edit-att-id').value;
    const name = $('inp-att-name').value.trim();
    const phone = $('inp-att-phone').value.trim();
    const role = document.querySelector('#role-chips .chip.selected')?.dataset.role || 'invitado';
    const vip = role === 'protagonista'; // Novio/novia no paga
    const paid = parseFloat($('inp-att-paid').value) || 0;
    
    if(!name) { toast('Pon un nombre'); return; }
    
    // If setting as protagonista, remove that role from others
    if(vip) {
        E.attendees.forEach(a => {
            if(a.role === 'protagonista') a.role = 'invitado';
            a.vip = false;
        });
    }
    
    if(id) {
        // Edit existing
        const a = E.attendees.find(x => x.id === id);
        if(a) {
            a.name = name;
            a.phone = phone;
            a.role = role;
            a.vip = vip;
            a.paid = paid;
        }
        toast('Asistente actualizado');
    } else {
        // Add new
        E.attendees.push({id: Date.now().toString(), name, phone, role, vip, paid: 0});
        toast('Asistente a√±adido');
    }
    
    save();
    closeModal('modal-attendee');
    renderAtt();
}

function deleteAttendee() {
    const id = $('edit-att-id').value;
    if(!id) return;
    if(!confirm('¬øEliminar este asistente?')) return;
    
    E.attendees = E.attendees.filter(a => a.id !== id);
    
    // Remove from expense participants
    E.expenses.forEach(exp => {
        if(exp.participants) {
            exp.participants = exp.participants.filter(p => p !== id);
        }
        if(exp.paidBy === id) exp.paidBy = null;
    });
    
    save();
    closeModal('modal-attendee');
    renderAtt();
    toast('Asistente eliminado');
}

// ==================== CONTACTS API ====================
async function addFromContacts() {
    // Check if Contact Picker API is available
    if(!('contacts' in navigator && 'ContactsManager' in window)) {
        toast('Tu navegador no soporta acceso a contactos. Usa Chrome en Android.');
        return;
    }
    
    try {
        const props = ['name', 'tel'];
        const opts = {multiple: true};
        const contacts = await navigator.contacts.select(props, opts);
        
        if(contacts && contacts.length) {
            let added = 0;
            contacts.forEach(c => {
                const name = c.name && c.name[0] ? c.name[0] : 'Sin nombre';
                const phone = c.tel && c.tel[0] ? c.tel[0] : '';
                
                // Check if already exists (by phone)
                const exists = phone && E.attendees.some(a => a.phone === phone);
                if(!exists) {
                    E.attendees.push({
                        id: Date.now().toString() + Math.random(),
                        name: name,
                        phone: phone,
                        role: 'invitado',
                        vip: false,
                        paid: 0
                    });
                    added++;
                }
            });
            
            if(added > 0) {
                save();
                renderAtt();
                toast(`${added} contacto${added>1?'s':''} a√±adido${added>1?'s':''}`);
            } else {
                toast('Los contactos ya estaban a√±adidos');
            }
        }
    } catch(err) {
        console.error('Contacts error:', err);
        if(err.name === 'SecurityError') {
            toast('Permite el acceso a contactos en tu navegador');
        } else {
            toast('No se pudieron obtener los contactos');
        }
    }
}

// ==================== EXPENSE ACTIONS ====================
function prepareExpenseModal(expId = null) {
    const isEdit = !!expId;
    $('modal-exp-title').textContent = isEdit ? 'Editar gasto' : 'A√±adir gasto';
    $('edit-exp-id').value = expId || '';
    $('exp-danger').style.display = isEdit ? 'block' : 'none';
    
    // Populate payer dropdown
    const sel = $('inp-exp-payer');
    sel.innerHTML = '<option value="">Nadie a√∫n / Bote com√∫n</option>' + 
        E.attendees.map(a => `<option value="${a.id}">${a.name}</option>`).join('');
    
    // Populate participants (non-VIP only)
    const nonVip = E.attendees.filter(a => !a.vip);
    
    if(isEdit) {
        const exp = E.expenses.find(x => x.id === expId);
        if(!exp) return;
        $('inp-exp-name').value = exp.name;
        $('inp-exp-amount').value = exp.amount;
        sel.value = exp.paidBy || '';
        
        const parts = exp.participants || nonVip.map(a => a.id);
        $('exp-participants').innerHTML = nonVip.map(a => 
            `<span class="chip ${parts.includes(a.id)?'selected':''}" data-id="${a.id}">${a.name}</span>`
        ).join('');
    } else {
        $('inp-exp-name').value = '';
        $('inp-exp-amount').value = '';
        sel.value = '';
        // All selected by default
        $('exp-participants').innerHTML = nonVip.map(a => 
            `<span class="chip selected" data-id="${a.id}">${a.name}</span>`
        ).join('');
    }
    
    openModal('modal-expense');
}

function saveExpense() {
    const id = $('edit-exp-id').value;
    const name = $('inp-exp-name').value.trim();
    const amount = parseFloat($('inp-exp-amount').value) || 0;
    const paidBy = $('inp-exp-payer').value || null;
    const participants = Array.from($$('#exp-participants .chip.selected')).map(c => c.dataset.id);
    
    if(!name || !amount) { toast('Pon nombre e importe'); return; }
    if(!participants.length) { toast('Selecciona al menos un participante'); return; }
    
    if(id) {
        // Edit existing
        const exp = E.expenses.find(x => x.id === id);
        if(exp) {
            exp.name = name;
            exp.amount = amount;
            exp.paidBy = paidBy;
            exp.participants = participants;
        }
        toast('Gasto actualizado');
    } else {
        // Add new
        E.expenses.push({
            id: 'e'+Date.now(),
            catId: catId,
            name: name,
            amount: amount,
            paidBy: paidBy,
            participants: participants
        });
        toast('Gasto a√±adido');
    }
    
    save();
    closeModal('modal-expense');
    renderExpenses();
}

function deleteExpense() {
    const id = $('edit-exp-id').value;
    if(!id) return;
    if(!confirm('¬øEliminar este gasto?')) return;
    
    E.expenses = E.expenses.filter(x => x.id !== id);
    save();
    closeModal('modal-expense');
    renderExpenses();
    toast('Gasto eliminado');
}

// ==================== CREATE EVENT ====================
function createEvent() {
    const name = $('inp-name').value.trim();
    const phone = $('inp-phone').value.trim();
    const city = $('inp-city').value.trim();
    const date = $('inp-date').value;
    const type = document.querySelector('#type-chips .chip.selected')?.dataset.type || 'soltera';
    
    if(!name || !phone || !city || !date) { toast('Rellena todos los campos'); return; }
    
    const code = genCode();
    E = {
        code, city, date, type,
        organizer: {name, phone},
        attendees: [{id: Date.now().toString(), name, phone, role: 'organizador', vip: false, paid: 0}],
        categories: JSON.parse(JSON.stringify(DEFAULT_CATS)),
        expenses: [],
        createdAt: new Date().toISOString()
    };
    save();
    sendWebhook();
    nav('screen-dashboard');
    toast('¬°Creada! C√≥digo: ' + code);
}

function sendWebhook() {
    fetch('https://hook.eu2.make.com/toyfa30mf13arg2v7wege89p1hjgrn7v', {
        method: 'POST',
        headers: {'Content-Type': 'application/json'},
        body: JSON.stringify({
            evento_id: E.code,
            organizador_nombre: E.organizer.name,
            organizador_telefono: E.organizer.phone,
            ciudad: E.city,
            fecha_evento: E.date,
            num_asistentes: E.attendees.length,
            created_at: E.createdAt
        }),
        mode: 'no-cors'
    }).catch(() => {});
}

function addCategory() {
    const name = $('inp-cat-name').value.trim();
    const icon = document.querySelector('#icon-chips .chip.selected')?.dataset.icon || 'üì¶';
    if(!name) { toast('Pon un nombre'); return; }
    const colors = ['#4CAF50','#2196F3','#FF9800','#9C27B0','#E91E63','#607D8B','#795548','#00BCD4'];
    E.categories.push({id: 'c'+Date.now(), name, icon, color: colors[Math.floor(Math.random()*colors.length)]});
    save();
    closeModal('modal-category');
    renderCats();
    toast('Categor√≠a creada');
    $('inp-cat-name').value = '';
}

// ==================== WHATSAPP & PDF ====================
function genWhatsAppMsg() {
    const stats = calcPersonStats();
    const totals = calcStats();
    const frasesGallegas = [
        "Non sexas rato... bota o cartino! üê≠",
        "Bota a pasta e logo bebe auga üí∏",
        "Quen non pon, non come üçΩÔ∏è",
        "A boa festa pagase entre todos üéâ",
        "Menos ratonar e mais Bizum üì±"
    ];
    const frase = frasesGallegas[Math.floor(Math.random()*frasesGallegas.length)];
    
    let m = `üéâ *DESPEDIDA EN ${E.city.toUpperCase()}*\n`;
    m += `üìÖ ${new Date(E.date).toLocaleDateString('es-ES',{day:'numeric',month:'long'})}\n\n`;
    m += `üí∞ *TOTAL: ${totals.total.toFixed(0)}‚Ç¨*\n`;
    m += `üë• Por persona: ${totals.pp.toFixed(0)}‚Ç¨\n\n`;
    
    m += `üìä *DESGLOSE DE GASTOS:*\n`;
    E.categories.forEach(c => {
        const exps = E.expenses.filter(x=>x.catId===c.id);
        const catTotal = exps.reduce((s,x)=>s+x.amount,0);
        if(catTotal > 0) {
            m += `\n${c.icon} *${c.name}:* ${catTotal.toFixed(0)}‚Ç¨\n`;
            exps.forEach(exp => {
                const payer = exp.paidBy ? E.attendees.find(a=>a.id===exp.paidBy) : null;
                m += `   ‚Ä¢ ${exp.name}: ${exp.amount.toFixed(0)}‚Ç¨${payer?' ('+payer.name+')':''}\n`;
            });
        }
    });
    
    m += `\nüë§ *CADA UNO DEBE:*\n`;
    E.attendees.forEach(a => {
        const role = a.role || (a.vip ? 'protagonista' : 'invitado');
        const isVip = role === 'protagonista' || a.vip;
        
        if(isVip) { 
            m += `üëë ${a.name}: ¬°NO PAGA - PROTAGONISTA!\n`; 
        } else {
            const s = stats[a.id] || {owes:0,paid:0};
            const bal = s.paid - s.owes;
            const roleIcon = role === 'organizador' ? 'üìã ' : '';
            m += `${bal>=0?'‚úÖ':'‚è≥'} ${roleIcon}${a.name}: ${Math.max(0,-bal).toFixed(0)}‚Ç¨\n`;
        }
    });
    m += `\nüí≥ *Bizum:* ${E.organizer.phone}\nüì± *C√≥digo:* ${E.code}\n\n`;
    m += `_${frase}_\n`;
    m += `_despedidasgalicia.es_`;
    return m;
}

function exportPDF() {
    const {jsPDF} = window.jspdf;
    const doc = new jsPDF();
    const stats = calcPersonStats();
    const totals = calcStats();
    
    const frasesGallegas = [
        "Non sexas rato... bota o carti√±o!",
        "Bota a pasta e logo bebe auga",
        "Quen non pon, non pon... pero tampouco come",
        "A boa festa pagase entre todos",
        "Menos rato√±ar e mais Bizum"
    ];
    const frase = frasesGallegas[Math.floor(Math.random()*frasesGallegas.length)];
    
    // Header
    doc.setFillColor(233,30,99);
    doc.rect(0,0,210,40,'F');
    doc.setTextColor(255,255,255);
    doc.setFontSize(22);
    doc.text('DESPEDIDA EN '+E.city.toUpperCase(), 105, 18, {align:'center'});
    doc.setFontSize(12);
    doc.text(new Date(E.date).toLocaleDateString('es-ES',{day:'numeric',month:'long',year:'numeric'}), 105, 28, {align:'center'});
    doc.text('Codigo: '+E.code, 105, 36, {align:'center'});
    
    let y = 55;
    doc.setTextColor(26,26,46);
    doc.setFontSize(14);
    doc.text('RESUMEN GENERAL', 20, y);
    y += 10;
    doc.setFontSize(11);
    doc.text('Total: '+totals.total.toFixed(0)+'E  |  Por persona: '+totals.pp.toFixed(0)+'E  |  Pendiente: '+totals.pending.toFixed(0)+'E', 20, y);
    
    y += 18;
    doc.setFontSize(14);
    doc.text('DESGLOSE DE GASTOS', 20, y);
    y += 10;
    
    // Desglose por categoria con gastos individuales
    E.categories.forEach(c => {
        const exps = E.expenses.filter(x => x.catId === c.id);
        const catTotal = exps.reduce((s,x) => s + x.amount, 0);
        if(catTotal > 0) {
            if(y > 250) { doc.addPage(); y = 20; }
            doc.setFontSize(11);
            doc.setTextColor(233,30,99);
            doc.text(c.icon+' '+c.name+': '+catTotal.toFixed(0)+'E', 20, y);
            y += 7;
            doc.setTextColor(107,114,128);
            doc.setFontSize(9);
            exps.forEach(exp => {
                const payer = exp.paidBy ? E.attendees.find(a=>a.id===exp.paidBy) : null;
                const payerTxt = payer ? ' (pago '+payer.name+')' : '';
                doc.text('   - '+exp.name+': '+exp.amount.toFixed(0)+'E'+payerTxt, 25, y);
                y += 5;
                if(y > 270) { doc.addPage(); y = 20; }
            });
            y += 3;
        }
    });
    
    y += 10;
    if(y > 230) { doc.addPage(); y = 20; }
    
    doc.setFontSize(14);
    doc.setTextColor(26,26,46);
    doc.text('LO QUE DEBE CADA UNO', 20, y);
    y += 10;
    doc.setFontSize(10);
    
    E.attendees.forEach(a => {
        const s = stats[a.id] || {owes:0,paid:0};
        const bal = s.paid - s.owes;
        const role = a.role || (a.vip ? 'protagonista' : 'invitado');
        const isVip = role === 'protagonista' || a.vip;
        
        if(isVip) {
            doc.setTextColor(255,193,7);
            doc.text('CORONA '+a.name+' - NO PAGA (Protagonista)', 25, y);
        } else {
            const pendiente = Math.max(0, -bal);
            if(bal >= 0) {
                doc.setTextColor(76,175,80);
                doc.text('OK '+a.name+': Todo pagado (+'+bal.toFixed(0)+'E a favor)', 25, y);
            } else {
                doc.setTextColor(255,87,34);
                doc.text('PEND '+a.name+': Debe '+pendiente.toFixed(0)+'E (pago '+s.paid.toFixed(0)+'E de '+s.owes.toFixed(0)+'E)', 25, y);
            }
        }
        y += 7;
        if(y > 270) { doc.addPage(); y = 20; }
    });
    
    // Frase gallega
    y += 12;
    if(y > 260) { doc.addPage(); y = 20; }
    doc.setFillColor(250,250,250);
    doc.roundedRect(15, y-5, 180, 15, 3, 3, 'F');
    doc.setFontSize(10);
    doc.setTextColor(26,26,46);
    doc.text('"'+frase+'" - www.despedidasgalicia.es', 105, y+4, {align:'center'});
    
    // Footer
    doc.setFontSize(9);
    doc.setTextColor(107,114,128);
    doc.text('www.despedidasgalicia.es - 678 288 284 - Que viva a festa!', 105, 285, {align:'center'});
    
    doc.save('despedida_'+E.city.toLowerCase().replace(/\s+/g,'_')+'_'+E.code+'.pdf');
    toast('PDF descargado');
}

// ==================== EVENT LISTENERS ====================
document.addEventListener('DOMContentLoaded', function() {
    // Navigation
    $('btn-create').onclick = () => nav('screen-create');
    $('btn-back-home').onclick = () => nav('screen-home');
    $('btn-recover').onclick = () => openModal('modal-recover');
    $('btn-back-expenses').onclick = () => nav('screen-expenses');
    
    // Create event
    $('btn-submit-create').onclick = createEvent;
    $('btn-submit-recover').onclick = () => {
        const code = $('inp-recover').value.trim().toUpperCase();
        if(load(code)) { closeModal('modal-recover'); nav('screen-dashboard'); toast('Cargado'); }
        else toast('C√≥digo no encontrado');
    };
    
    // Attendees
    $('btn-add-attendee').onclick = () => openAttendeeModal();
    $('btn-add-contact').onclick = addFromContacts;
    $('btn-submit-attendee').onclick = saveAttendee;
    $('btn-delete-attendee').onclick = deleteAttendee;
    
    // Click on attendee to edit
    document.addEventListener('click', e => {
        const att = e.target.closest('#attendees-list .attendee-item');
        if(att) openAttendeeModal(att.dataset.id);
    });
    
    // Categories
    $('btn-add-category').onclick = () => openModal('modal-category');
    $('btn-submit-category').onclick = addCategory;
    
    // Click on category
    document.addEventListener('click', e => {
        const cat = e.target.closest('.category-item');
        if(cat) { catId = cat.dataset.id; nav('screen-category'); }
    });
    
    // Expenses
    $('btn-add-expense').onclick = () => prepareExpenseModal();
    $('btn-submit-expense').onclick = saveExpense;
    $('btn-delete-expense').onclick = deleteExpense;
    
    // Click on expense to edit
    document.addEventListener('click', e => {
        const exp = e.target.closest('#expenses-list .expense-item');
        if(exp) prepareExpenseModal(exp.dataset.id);
    });
    
    // Share & WhatsApp
    $('btn-share').onclick = () => { $('share-code').textContent = E.code; openModal('modal-share'); };
    $('btn-whatsapp').onclick = () => { $('wa-preview').textContent = genWhatsAppMsg(); openModal('modal-whatsapp'); };
    $('btn-whatsapp2').onclick = () => { $('wa-preview').textContent = genWhatsAppMsg(); openModal('modal-whatsapp'); };
    $('btn-copy-code').onclick = () => { navigator.clipboard.writeText(E.code); toast('Copiado'); };
    $('btn-share-wa').onclick = () => window.open('https://wa.me/?text='+encodeURIComponent('üéâ Despedida en '+E.city+'\nC√≥digo: '+E.code));
    $('btn-copy-wa').onclick = () => { navigator.clipboard.writeText($('wa-preview').textContent); toast('Copiado'); };
    $('btn-send-wa').onclick = () => window.open('https://wa.me/?text='+encodeURIComponent($('wa-preview').textContent));
    $('btn-pdf').onclick = exportPDF;
    $('dash-code').onclick = () => { navigator.clipboard.writeText(E.code); toast('C√≥digo copiado'); };
    
    // Close modals
    $$('.modal-close').forEach(btn => btn.onclick = () => closeModal(btn.dataset.close));
    $$('.modal-overlay').forEach(m => m.onclick = e => { if(e.target === m) closeModal(m.id); });
    
    // Chips - roles
    $$('#role-chips .chip').forEach(c => c.onclick = function() {
        $$('#role-chips .chip').forEach(x => x.classList.remove('selected'));
        this.classList.add('selected');
    });
    
    // Chips - type
    $$('#type-chips .chip').forEach(c => c.onclick = function() {
        $$('#type-chips .chip').forEach(x => x.classList.remove('selected'));
        this.classList.add('selected');
    });
    
    // Chips - icons
    $$('#icon-chips .chip').forEach(c => c.onclick = function() {
        $$('#icon-chips .chip').forEach(x => x.classList.remove('selected'));
        this.classList.add('selected');
    });
    
    // Chips - participants (toggle)
    document.addEventListener('click', e => {
        if(e.target.matches('#exp-participants .chip')) {
            e.target.classList.toggle('selected');
        }
    });
    
    // Nav buttons
    $$('.nav-item').forEach(n => n.onclick = () => nav(n.dataset.screen));
    
    // Init
    $('inp-date').min = new Date().toISOString().split('T')[0];
    const lastCode = localStorage.getItem('lastCode');
    if(lastCode && load(lastCode)) nav('screen-dashboard');
    else nav('screen-home');
});
</script>
</body>
</html>
